{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">F5. Batch Import Movie Data (Append Mode)</h2>

<div class="card p-4">
    <!-- Drag and drop area -->
    <div id="dropArea" class="border-2 border-dashed rounded p-5 text-center mb-4" style="min-height: 150px;">
        <i class="fas fa-file-csv fa-3x text-primary mb-2"></i>
        <p>Drag and drop CSV file here, or <button type="button" class="btn btn-link p-0" onclick="document.getElementById('fileInput').click()">select file</button></p>
        <input type="file" id="fileInput" name="csv_file" accept=".csv" style="display: none;">
        <div id="fileInfo" class="mt-2"></div>
    </div>

    <form id="uploadForm" method="post" enctype="multipart/form-data">
        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Confirm Import</button>
        <a href="{{ url_for('admin_menu') }}" class="btn btn-secondary">Return to F Menu</a>
    </form>

    {% if message %}
    <div class="mt-3 alert {{ 'alert-success' if success else 'alert-danger' }}">
        {{ message }}
    </div>
    {% endif %}
</div>

<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const submitBtn = document.getElementById('submitBtn');
let selectedFile = null;

// Drag and drop event handling
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropArea.classList.add('border-primary', 'bg-light-blue');
}

function unhighlight() {
    dropArea.classList.remove('border-primary', 'bg-light-blue');
}

dropArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const file = dt.files[0];
    handleFiles(file);
}

// File selection handling
fileInput.addEventListener('change', function() {
    handleFiles(this.files[0]);
});

function handleFiles(file) {
    if (!file) return;
    
    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        fileInfo.innerHTML = '<span class="text-danger">Please select a CSV format file</span>';
        selectedFile = null;
        submitBtn.disabled = true;
        return;
    }

    selectedFile = file;
    fileInfo.innerHTML = `<span class="text-success">Selected file: ${file.name} (${(file.size/1024).toFixed(1)}KB)</span>`;
    document.getElementById('uploadForm').reset();
    submitBtn.disabled = false;
}

// Form submission handling
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    if (!selectedFile) {
        e.preventDefault();
        alert('Please select a CSV file first');
        return;
    }

    // Create FormData and add file
    const formData = new FormData(this);
    formData.append('csv_file', selectedFile);
});
</script>
{% endblock %}